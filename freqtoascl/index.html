<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
  <title>Freq To ASCL Generator</title>
</head>
<body>
  <section>
    <h1>freqToAscl</h1>
    <details>
      <summary>
        About
      </summary>
      <p class="info">
        This tool allows you to define absolute note frequencies in Ableton by generating an .ascl 
        tuning file from a list of hz values, tuning all 128 notes and assigning values to note names 
        that appear in the piano roll. Enter frequencies as a list separated by a space or comma, lists 
        with less than 128 values will be automatically wrapped so the sequence of values repeats to fill 128 notes.
      </p>
    </details>


    <div class="inputs">
      <textarea id="title" rows="1" placeholder="Enter scale name"></textarea>
      <textarea id="description" rows="5" placeholder="Enter description"></textarea>
      <textarea id="frequencies" rows="10" placeholder="Enter frequencies"></textarea>
    </div>
    
    <button onclick="generateASCL()">Save File</button>
  </section>
 

  <script>
    function generateASCL() {
      const frequenciesInput = document.getElementById('frequencies').value;
      const frequencies = frequenciesInput
        .split(/[\s,]+/) // Split on one or more spaces, commas, or a combination
        .map(f => parseFloat(f.trim()))
        .filter(f => !isNaN(f)); // Filter out invalid numbers

      const title = document.getElementById('title').value;
      const description = document.getElementById('description').value;
      let keyMapping;

      if (frequencies.length !== 128) {
        keyMapping = createKeyMapping(frequencies);        ;
      } else {
        keyMapping = frequencies;
      }

      const referenceNoteIndex = 0;
      const referenceFrequency = frequencies[0];
      const referenceNote = 0;
      const referenceOctave = -2  ;
      const baseFrequency = keyMapping[referenceNoteIndex];
      const cents = keyMapping.map((frequency) => 1200 * Math.log2(frequency / baseFrequency));

      let asclContent = `! ${title}.ascl\n${description}\n!\n ${keyMapping.length}\n!\n`;

      for (let i = 0; i < keyMapping.length; i++) {
        asclContent += ` ${cents[i].toFixed(6)} ! ${keyMapping[i]}hz\n`;
      }

      asclContent += `!\n! @ABL NOTE_RANGE_BY_FREQUENCY ${frequencies[0]} ${frequencies[frequencies.length - 1]}`;

      asclContent += `\n! @ABL REFERENCE_PITCH ${referenceOctave} ${referenceNote} ${referenceFrequency}\n! @ABL NOTE_NAMES `;

      for (let i = 0; i < keyMapping.length; i++) {
        asclContent += `${keyMapping[i]} `;
      }

      asclContent += `\n! @ABL SOURCE File generated by freqToAscl.`;
      asclContent += `\n! @ABL LINK ultradian7.github.io`;
      asclContent += `\n`;

      download(`${title}.ascl`, asclContent);
    }

    function createKeyMapping(values, whiteKeysOnlySetting) {
      let freqMapping = new Array(128).fill(null);

      if (whiteKeysOnlySetting) {
        const whiteKeys = utils.generateWhiteKeys();
        whiteKeys.forEach(
          (
            keyIndex,
            valueIndex // Map values to white keys directly. If values run out, repeat them from the start.
          ) => {
            freqMapping[keyIndex] = values[valueIndex % values.length];
          }
        );

        // Fill in black keys by copying the frequency from the last white key
        freqMapping.forEach((val, index, arr) => {
          if (val === null) {
            arr[index] = arr[index - 1];
          } // Repeat the previous frequency
        });
      } // Not whiteKeysOnlySetting: Distribute the values across all 128 keys, repeating if necessary
      else {
        for (let i = 0; i < freqMapping.length; i++) {
          freqMapping[i] = values[i % values.length];
        }
      }

      if (freqMapping.length > 128) {
        freqMapping = freqMapping.slice(0, 128);
      }

      return freqMapping;
    }

    function download(filename, text) {
      const element = document.createElement('a');
      const blob = new Blob([text], { type: 'text/plain' });
      element.href = URL.createObjectURL(blob);
      element.download = filename;
      document.body.appendChild(element);
      element.click();
      document.body.removeChild(element);
    }

  </script>
</body>
</html>
